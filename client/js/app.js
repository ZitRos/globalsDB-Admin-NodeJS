var dataAdapter=new function(){var a="___$",b="___J",c=this,d={},e={root:{___$:"Welcome!",Welcome:"Log in",To:"",The:"",GlobalsDB:"Please",Admin:""}},f=function(a){var b=a.slice().pop(),c=g(a.slice(0,a.length-1));c&&c.hasOwnProperty(b)&&(c[b]={})},g=function(a){var b=-1,c=e;do b++,a[b]&&(c=c[a[b]]),"object"!=typeof c&&(c=null);while(a[b]&&c);return c},h=function(a,b){var c=g(a);return c&&a&&b?void(c.hasOwnProperty(b)||(c[b]={})):void console.error("Wrong server data flow.")},i=function(a){var b=g(a.slice(0,a.length-1)),c=a.pop();b.hasOwnProperty(c)?delete b[c]:console.log("Unable to delete from tree ",a)},j=function(b,c){var d=g(b);"object"==typeof d?d[a]=c:console.error("Make sure you're on a right way.")},k=function(a){var b=a.join(",");return d.hasOwnProperty(b)},l=function(a,b){var c=a.join(",");b?d[c]=1:d.hasOwnProperty(c)&&delete d[c]},m=new function(){this.requestNodeValue=function(a){var b=a.slice(1),d={pathArray:b};server.send({request:"getNode",data:d},function(e){return e&&!e.error&&e.result?(j(a,e.result.data),void c.nodeValueUpdated(b)):void console.error("Sever data error: ",{request:d,data:e})})},this.requestLevelData=function(a,d){if(!k(a)){var e=a.slice(1),f=0,i={pathArray:e,max:50},j=g(a);j.hasOwnProperty(b)&&(i.lo=j[b]),d&&(i.lo=d),server.send({request:"getLevel",data:i},function(b){if(!b||b.error||!b.result)return void console.error("Sever data error: ",b);for(var d in b.result)b.result.hasOwnProperty(d)&&(h(a,b.result[d].name),f++);f<i.max&&l(a,!0),c.childUpdated(e)})}}};this.childUpdated=function(){},this.nodeValueUpdated=function(){},this.getLevel=function(c,d,f){var g,h=-1,i=e,j=[],k="";d||(d=1/0);do h++,c[h]&&(i=i[c[h]]),"object"!=typeof i&&(i=null);while(c[h]&&i);for(g in i)if(i.hasOwnProperty(g)&&g!==a&&g!==b){if(f){if(g!==f)continue;f=!1}if(!(d>0))break;d--,j.push(g),k=g}return d>0&&m.requestLevelData(c,k),j},this.getValue=function(b){if(!(b instanceof Array))return"";for(var c=e,d=0;b[d]&&"object"==typeof c;)c=c[b[d]],d++;return"object"==typeof c&&"undefined"==typeof c[a]&&m.requestNodeValue(b),"object"==typeof c?"undefined"==typeof c[a]?"":c[a]:c},this.setNode=function(a,b,d,e){var f=a.concat(b),g=f.slice(1);server.send({request:"setNode",data:{pathArray:g,data:d}},function(i){i&&!i.error?(h(a,b),j(f,d),c.childUpdated(a.slice(1)),c.nodeValueUpdated(g),"function"==typeof e&&e(!0)):(console.log("Wrong response",i),"function"==typeof e&&e(!1))})},this.deleteNode=function(a,b){server.send({request:"killNode",data:{pathArray:a.slice(1)}},function(d){d&&!d.error?(i(a),c.childUpdated(a.slice(1)),"function"==typeof b&&b(!0)):(console.log("Wrong kill request.",d),"function"==typeof b&&b(!1))})},this.getDataTree=function(){return e},this.setJumper=function(a,d){var e=g(a);e&&(l(a,!1),d?(f(a),e=g(a),e[b]=d,c.childUpdated(a.slice(1))):(e.hasOwnProperty(b)&&delete e[b],f(a),c.childUpdated(a.slice(1))))},this.reset=function(a){e.root={___$:a||"root"},d={}}},Geometry={normalizeAngle:function(a){return(a+2*Math.PI)%(2*Math.PI)},angleDifference:function(a,b){return Math.atan2(Math.sin(b-a),Math.cos(b-a))}},blockEvent=function(a){a.preventDefault(),a.cancelBubble=!0,a.preventDefault&&(a.preventDefault(),a.stopPropagation())},app=new function(){var a,b={VIEWPORT:null,FIELD:null,TREE_PATH:null},c=!1,d=dataAdapter,e=null,f="1.0.0",g=!0,h=!0,i="node",j="link",k="selected",l="deleting",m="editing",n="",o=0,p=1,q=2,r=3,s=15,t=110,u=140,v=80,w=0,x=0,y=1,z=function(){b.VIEWPORT=document.getElementById("fieldViewport"),b.FIELD=document.getElementById("field"),b.TREE_PATH=document.getElementById("treePath")},A=function(){var a,b=document.createElement("p"),c={webkitTransform:"-webkit-transform",OTransform:"-o-transform",msTransform:"-ms-transform",MozTransform:"-moz-transform",transform:"transform"};document.body.insertBefore(b,null);for(var d in c)c.hasOwnProperty(d)&&void 0!==b.style[d]&&(b.style[d]="translate3d(1px,1px,1px)",a=window.getComputedStyle(b,null).getPropertyValue(c[d]));return document.body.removeChild(b),void 0!==a&&a.length>0&&"none"!==a},B=function(){var c=this,d=window.innerWidth,f=window.innerHeight,h=0,i=0,j=0,k=0,l=1,m=1e5,n=1e5,o=.3,p=3,q=0,r={ox:0,oy:0,x:0,y:0,target:null,event:null,pressed:!1};this.getRelativeCenter=function(){return{x:m/2,y:n/2}},this.getViewX=function(){return h-m/2},this.getViewY=function(){return i-n/2},this.scaleView=function(a){var c=b.FIELD;l+=a,l=Math.max(o,Math.min(p,l)),c.style.transform=c.style["-ms-transform"]=c.style["-o-transform"]=c.style["-moz-transform"]=c.style["-webkit-transform"]="scale("+l+")"},this.setViewCenter=function(a,b){h=m/2+a*l-d/2,i=n/2+b*l-f/2,q||(q=setInterval(s,25))};var s=function(){var a,c;j+=a=(h-j)/2,k+=c=(i-k)/2,Math.abs(a)+Math.abs(c)<.001&&(clearInterval(q),q=0,j=h,k=i),b.VIEWPORT.scrollLeft=Math.round(j),b.VIEWPORT.scrollTop=Math.round(k)},t=new function(){var a,b=0,e=function(){var b=a;if(b.scrolling){var d=b.scrolling.parentNode,e=-Math.atan2(b.x-b.ox,b.oy-b.y)+Math.PI/2,f=Geometry.angleDifference(e,b.scrolling.angle);return d.childController.updateSelectedIndex(-f),b.scrolling.angle=e,void(Math.abs(f)<.001&&h())}if(!b.event.changedTouches||b.event.changedTouches.length<2);else{var g=Math.sqrt(Math.pow(b.event.changedTouches[0].pageX-b.event.changedTouches[1].pageX,2)+Math.pow(b.event.changedTouches[0].pageY-b.event.changedTouches[1].pageY,2));b.ld&&(b.i++,c.scaleView((g-b.ld)/100)),b.ld=g}c.setViewCenter(b.ovx+(b.ox-b.x)/l,b.ovy+(b.oy-b.y)/l)},g=function(){b||(clearInterval(b),b=setInterval(e,30))},h=function(){clearInterval(b),b=0};this.started=function(a){a.ox=a.x,a.oy=a.y,a.i=0,a.ld=void 0,a.ovx=(c.getViewX()+d/2)/l,a.ovy=(c.getViewY()+f/2)/l,a.scrolling=null;var b=a.target;do{if(b.NODE_OBJECT){var e;try{e=b.NODE_OBJECT.getParent()}catch(a){e=null}if(e&&!e.childController.isFreeAligned()){a.scrolling={currentNode:b.NODE_OBJECT,parentNode:e,angle:0};var g=-Math.atan2(b.NODE_OBJECT.getX()-e.getX(),e.getY()-b.NODE_OBJECT.getY())+Math.PI/2,h=Math.sqrt(Math.pow(b.NODE_OBJECT.getX()-e.getX(),2)+Math.pow(b.NODE_OBJECT.getY()-e.getY(),2));a.scrolling.angle=g,a.ox=a.ox-Math.cos(g)*h*l,a.oy=a.oy+Math.sin(g)*h*l}}b=b.parentNode}while(b)},this.moved=function(b){blockEvent(b.event),a=b,g()},this.ended=function(a){blockEvent(a.event),h()}},u=new function(){var a={},b=1,c=0;this.keyPress=function(c,d){a[c]=b;var f=function(a){e&&e.scrollEvent(a)};switch(c){case 8:e&&e.backEvent(),blockEvent(d);break;case 13:e&&e.triggerEvent();break;case 37:e&&e.changeStateAction(-1);break;case 38:f(-1);break;case 39:e&&e.changeStateAction(1);break;case 40:f(1)}},this.keyRelease=function(b){a[b]=c}};this.viewportUpdated=function(){d=window.innerWidth,f=window.innerHeight},this.resetViewport=function(){b.FIELD.style.width=m+"px",b.FIELD.style.height=n+"px",c.setViewCenter(0,0),j=h,k=i},this.initialize=function(){a.viewportUpdated(),c.resetViewport();var d=function(a){var b=(a.touches||a.changedTouches||[a])[0];b&&(r.x=b.pageX,r.y=b.pageY,r.event=a,r.target=a.target||a.srcElement)};b.VIEWPORT.ontouchstart=function(a){g&&(r.pressed=!0,d(a),t.started(r))},b.VIEWPORT.ontouchmove=function(a){g&&(d(a),t.moved(r))},b.VIEWPORT.ontouchend=function(a){g&&(r.pressed=!1,d(a),t.ended(r))},b.VIEWPORT.onmousedown=function(a){g&&(r.pressed=!0,d(a),t.started(r))},b.VIEWPORT.onmousemove=function(a){g&&r.pressed&&(d(a),t.moved(r))},b.VIEWPORT.onmouseup=function(a){g&&(r.pressed=!1,d(a),t.ended(r))},b.VIEWPORT.onmousewheel=function(a){g&&c.scaleView(-(a.deltaY||a.wheelDelta)/2e3)},document.body.onkeydown=function(a){g&&u.keyPress(a.keyCode,a)},document.body.onkeyup=function(a){g&&u.keyRelease(a.keyCode,a)}}},C=function(f,g,j,z,A){var B=this,E=f instanceof C?f:null,F=[],G="",H={x:0,y:0,r:0,relativeX:a.getRelativeCenter().x,relativeY:a.getRelativeCenter().y,baseAngle:j},I="",J=null,K=o;this.setPosition=function(a,b){H.x=a,H.y=b,O()},this.setRadius=function(a){H.r=a,O()},this.setChild=function(a){if(a instanceof C){for(var b in F)if(F.hasOwnProperty(b)&&F[b]===a)return;F.push(a)}},this.setValue=function(a){I=a;try{J.childNodes[0].childNodes[0].innerHTML=I}catch(b){console.error("Unable to set value to node DOM element",b)}},this.setIndex=function(a){G=a,B.updateValue()},this.setZIndex=function(a){J&&(J.style.zIndex=a)},this.setBaseAngle=function(a){H.baseAngle=a},this.changeStateAction=function(a){K=Math.round(K+r+a)%r,B.childController.updateView()},this.getX=function(){return H.x},this.getY=function(){return H.y},this.getR=function(){return H.r},this.getParent=function(){return E},this.getIndex=function(){return G},this.getBaseAngle=function(){return j},this.getStateAction=function(){return K},this.getPath=function(){for(var a=[G],b=E;b;)a.unshift(b.getIndex()),b=b.getParent();return a},this.getChildNode=function(a){return B.childController.getChildNodeByIndex(a)},this.childController=new function(){var a=this,b=B,c=[],f={},g=0,i=s,j=30,r=0,u=0,v=0,w=!0,z=function(){c[-1]=void 0,c[-2]=void 0;var a={name:"jump to node",value:'<img src="img/jumpIcon.png" class="jumpIcon"/>',trigger:y},b={name:"add node",value:'<img src="img/addIcon.png" class="addIcon"/>',trigger:x};w?(g=1,c[-1]=b):(g=2,c[-1]=b,c[-2]=a)};this.getChildNodeByIndex=function(a){var b;for(var c in f)if(f.hasOwnProperty(c)&&(b=f[c].beam.getNode(),b.getIndex()===a))return b;return null},this.isFreeAligned=function(){return w},this.getCurrentNode=function(){return a.getChildNodeByIndex(c[Math.round(r)])},this.triggerEvent=function(){if(f[Math.round(r)])switch(a.forceViewUpdate(),K){case o:a.handleSelect();break;case p:a.handleEdit();break;case q:a.handleDelete()}};var A=function(a){switch(a){case x:e.handler.addNode();break;case y:e.handler.jumpNode();break;default:console.log("Unrecognised trigger")}};this.handleSelect=function(){var a=f[Math.round(r)].beam,b=a.getNode(),c=b.getIndex();return"object"==typeof c&&"undefined"!=typeof c.trigger?void A(c.trigger):(a.setRadius(2.5*a.getInitialRadius()),b.initChild(),void e.setTriggeringNode(b))},this.handleEdit=function(){var b=a.getCurrentNode();b&&e.handler.editNode(b.getPath())},this.handleDelete=function(){var b=a.getCurrentNode();b&&(h?confirm("Are you sure to delete "+b.getIndex()+"?")&&e.handler.deleteNode(b.getPath()):e.handler.deleteNode(b.getPath()))},this.updateSelectedIndex=function(b){var d=r;if(w)r=(r+b+c.length+g)%(c.length+g);else if(r=Math.max(-g,Math.min(c.length-1,r+b)),d!==r)try{f[Math.round(d)].beam.setRadius(f[Math.round(d)].beam.getInitialRadius()),f[Math.round(d)].beam.getNode().childController.removeBeams()}catch(e){console.error(e)}r+i/2>c.length&&C(),d!==r&&(w?a.updateView():F())},this.targetSelectionToSubPath=function(b){for(var c in f)if(f.hasOwnProperty(c)&&f[c].beam.getSubPath()===b)return a.updateSelectedIndex(f[c].index-r),f[c].index;return 0},this.removeBeams=function(){for(var a in f)f.hasOwnProperty(a)&&(f[a].beam.remove(),delete f[a])},this.update=function(){var b=c.length;C(),c.length!==b&&F(),a.updateSelectedIndex(0)};var C=function(){var a=r-Math.ceil(i/2),e=d.getLevel(b.getPath(),j,0>=a?"":c[a]);0>a&&(a=0);for(var f=0;f<e.length;f++)c[a+f]=e[f];c.splice(a+f,c.length-a-f),e.length+a-1>i/(E?2:1)&&(w=!1),z()},F=function(){if(w){var d,e=function(){for(var a in f)if(f.hasOwnProperty(a)){f[a].beam.setRadius(f[a].beam.getInitialRadius());var b=f[a].beam.getNode();b&&b.childController.removeBeams()}};for(var h in f)f.hasOwnProperty(h)&&f[h].beam.getSubPath()!=c[f[h].index]&&(f[h].beam.remove(),d=!0,delete f[h]);for(var j=0;j<c.length+g;j++)f[j]||(d=!0,f[j]={index:j,beam:new D(b,j<c.length?c[j]:c[c.length-j-1],0,0)});d&&e()}else{var k,l,m=Math.max(Math.ceil(r-i/2),-g),n=Math.min(Math.floor(r+i/2),c.length),o=[];for(k in f)f.hasOwnProperty(k)&&(m>k||k>=n)&&(o.push(f[k]),delete f[k]);for(k=m;n>k;k++){if(f.hasOwnProperty(k.toString())){if("object"!=typeof f[k].beam.getSubPath()){f[k].beam.getSubPath()!==c[f[k].index]&&c[f[k].index]&&f[k].beam.setSubPathName(c[f[k].index]);continue}f[k].beam.remove()}o.length?(l=o.pop(),l.beam.setSubPathName(c[k]),l.index=k,f[k]=l):f[k]={index:k,beam:new D(b,c[k],0,0)}}for(k=0;k<o.length;k++)o[k].beam.remove()}a.forceViewUpdate(),a.updateView()};this.updateView=function(){return w?(I(),void(v=0)):void(v||(v=setInterval(J,25)))},this.forceViewUpdate=function(){return w?(I(),void(v=0)):(clearInterval(v),v=0,void J())};var G=function(){switch(K){case o:return k;case p:return m;case q:return l;default:return n}},I=function(){var a,d,e,h,i=0,j=c.length+g,k=void 0!==H.baseAngle?1:0;for(var l in f)if(f.hasOwnProperty(l)){if(f[l].beam.highlight(Math.round(r)===f[l].index?G():n),k?(h=0,e=Math.PI,e=Math.min(e,Math.PI/6*j),d=e/(j||1)):(h=1/j*2*Math.PI/2,e=2*Math.PI-1/j*2*Math.PI,d=e/(j||1)),a=Geometry.normalizeAngle((H.baseAngle||0)+Math.PI-(j>1?e/2:0)+i/(j-1||1)*e-h)||0,!f[l].beam.getInitialRadius()){var m=Math.max(f[l].beam.getNode().getR()/Math.tan(d/2),f[l].beam.getNode().getR()+b.getR()+t);1/0===m&&(m=f[l].beam.getNode().getR()+b.getR()+t),f[l].beam.setRadius(m)}f[l].beam.setAngle(a),i++}},J=function(a){var c,d;a||(a=2.5),u+=c=(r-u)/a,Math.abs(c)<.001&&(u=r,clearInterval(v),v=0);for(var e in f)f.hasOwnProperty(e)&&(d=f[e].index-u,f[e].beam.updateGeometry(2*Math.atan(Math.PI/1.4*d*2/i*2)+("number"==typeof H.baseAngle?H.baseAngle:Math.PI)+Math.PI,Math.max(f[e].beam.getNode().getR()/Math.tan(2*Math.PI/i),f[e].beam.getNode().getR()+b.getR()+t),-Math.round(d*d)+200,Math.round(r)===f[e].index?G():n))};a.init=function(){C(),F()}};var L=function(){var a=B.getParent();a&&(a.childController.targetSelectionToSubPath(B.getIndex()),a.childController.triggerEvent())},M=function(a){a instanceof C&&a.setChild(B)},N=function(){var a=document.createElement("DIV");return a.className=i,a.NODE_OBJECT=B,a.innerHTML="<div><span>"+I+"</span></div>",a.onclick=L,b.FIELD.appendChild(a),a},O=function(){var a=Math.round(H.relativeX+H.x-H.r),b=Math.round(H.relativeY+H.y-H.r);c?J.style.transform=J.style["-ms-transform"]=J.style["-o-transform"]=J.style["-moz-transform"]=J.style["-webkit-transform"]="translate3d("+a+"px, "+b+"px, 0)":(J.style.left=a+"px",J.style.top=b+"px"),J.style.width=J.style.height=2*H.r+"px",w+=1};this.initChild=function(){B.childController.init()},this.back=function(){var a=B.getParent();a&&e.setTriggeringNode(a)},this.remove=function(){J&&J.parentNode.removeChild(J),B.childController.removeBeams()},this.updateValue=function(){B.setValue("object"==typeof G?G.value:d.getValue(B.getPath()))},this.highlight=function(a){J.className=i+" "+a},B.handle={updateChild:function(){B.childController.update()}};var P=function(){M(E),J=N(),B.setPosition(z,A),B.setRadius(null!=f?v:u),B.setIndex(g),O()};P()},D=function(d,e,f,g){var h={angle:Geometry.normalizeAngle(f||0),r:g||100,relativeX:a.getRelativeCenter().x,relativeY:a.getRelativeCenter().y,initialRadius:g,WIDTH_EXPAND:2,HALF_HEIGHT:3},i=this,k=new C(d,e,Geometry.normalizeAngle(h.angle+Math.PI),0,0),l=null,m=function(){d&&(d.childController.targetSelectionToSubPath(i.getSubPath()),d.changeStateAction(1))},n=function(){var a=document.createElement("DIV");return a.className=j,a.innerHTML="<div><div><div><span>"+("object"!=typeof e?e:e.name)+"</span></div></div></div>",a.onclick=m,b.FIELD.appendChild(a),h.HALF_HEIGHT=parseFloat(a.clientHeight)/2||3,a};this.setAngle=function(a){h.angle=Geometry.normalizeAngle(a),k.setBaseAngle(Geometry.normalizeAngle(h.angle+Math.PI)),p()},this.setRadius=function(a){h.initialRadius||(h.initialRadius=a),h.r=a,p()},this.setZIndex=function(a){l&&(l.style.zIndex=11+a),k&&k.setZIndex(12+a)},this.updateGeometry=function(a,b,c,d){h.angle=Geometry.normalizeAngle(a),k.setBaseAngle(Geometry.normalizeAngle(h.angle+Math.PI)),h.initialRadius||(h.initialRadius=b),h.r=b,l&&(l.style.zIndex=11+c),k&&k.setZIndex(12+c),l.className=j+" "+d,k&&k.highlight(d),p()},this.remove=function(){l&&l.parentNode.removeChild(l),k&&k.remove()},this.setSubPathName=function(a){e=a;try{l.childNodes[0].childNodes[0].childNodes[0].childNodes[0].innerHTML="object"!=typeof e?e:e.name}catch(b){console.error("Unable to set value to beam DOM element",b)}k.setIndex(a)},this.highlight=function(a){l.className=j+" "+a,k&&k.highlight(a)},this.getNode=function(){return k},this.getSubPath=function(){return e},this.getParentNode=function(){return d},this.getAngle=function(){return h.angle},this.getRadius=function(){return h.r},this.getInitialRadius=function(){return h.initialRadius};var o=function(){if(d&&k){var a=d.getX()-h.HALF_HEIGHT*Math.cos(h.angle+Math.PI/2),b=d.getY()-h.HALF_HEIGHT*Math.sin(h.angle+Math.PI/2),e=d.getR()-h.WIDTH_EXPAND,f=Math.sqrt(Math.pow(k.getX()-d.getX(),2)+Math.pow(k.getY()-d.getY(),2))-e-k.getR()+2*h.WIDTH_EXPAND,g=l.childNodes[0].childNodes[0];if(!(f>h.WIDTH_EXPAND))return void(l.style.display="none");g.style.display=60>f?"none":"block",l.style.display="block",l.style.width=Math.round(f)+"px",c?(l.style.transform=l.style["-ms-transform"]=l.style["-o-transform"]=l.style["-moz-transform"]=l.style["-webkit-transform"]="translate3d("+(h.relativeX+a+e*Math.cos(h.angle))+"px, "+(h.relativeY+b+e*Math.sin(h.angle))+"px, 0) rotate("+h.angle+"rad)",g.style.transform=g.style["-ms-transform"]=g.style["-o-transform"]=g.style["-moz-transform"]=g.style["-webkit-transform"]="rotate("+(h.angle<Math.PI/2||h.angle>Math.PI+Math.PI/2?0:180)+"deg)"):l.style.visibility="hidden",w+=1}},p=function(){k.setPosition(d.getX()+h.r*Math.cos(h.angle),d.getY()+h.r*Math.sin(h.angle)),o()},q=function(){l=n(),p()};q()},E=function(c){var d=this,e=null,f=null,g=function(){c=c||"ROOT",e=new C(null,"root",void 0,0,0),f=e,e.initChild(),h()},h=function(){var a,e=d.getCurrentPath(),f=e.slice();f[0]=c,b.TREE_PATH.innerHTML='<li onclick="uiController.switchInfoPanel();"><div><div>i</div></div></li>';for(var g=function(a,b){a.onclick=function(a){b&&(d.setTriggeringNode(b),blockEvent(a))}},h=0;h<e.length;h++){a=document.createElement("li"),a.innerHTML=f[h];var j=e.slice(1,h+1),k=i(j);g(a,k),b.TREE_PATH.appendChild(a)}},i=function(a){for(var b=e,c=0;c<a.length&&b;c++)b=b.getChildNode(a[c]);return b||null};this.getNodeByPath=i,dataAdapter.childUpdated=function(a){var b=i(a);b&&b.handle.updateChild()},dataAdapter.nodeValueUpdated=function(a){var b=i(a);b&&b.updateValue()},this.scrollEvent=function(a){f&&f.childController.updateSelectedIndex(a)},this.triggerEvent=function(){f&&f.childController.triggerEvent()},this.backEvent=function(){f&&f.back()},this.getCurrentPath=function(){return f?f.getPath():[]},this.setTriggeringNode=function(b){b instanceof C&&(f=b,a.setViewCenter(b.getX(),b.getY()),h())},this.handler={addNode:function(){uiController.switchAddNodeForm()},editNode:function(a){uiController.switchEditNodeForm(a[a.length-1],dataAdapter.getValue(a))},deleteNode:function(a){dataAdapter.deleteNode(a)},jumpNode:function(){uiController.switchJumpNodeForm()}},this.remove=function(){e&&e.remove(),f=null,e=null},this.changeStateAction=function(a){f&&f.changeStateAction(a)},g()};this.switchControl=function(a){g=a?!0:!1},this.updateViewport=function(){a&&a.viewportUpdated()},this.handle={connectionClose:function(){uiController.showMessage("Connection broken.","Client was disconnected from server."),uiController.switchConnectForm()},addNode:function(a,b){if(e){var c=e.getCurrentPath();c.length&&dataAdapter.setNode(c,a,b,function(c){c||uiController.showMessage("Failed to set node","Unable to set node ["+a+"] with value ["+b+"]")})}},editNode:function(a,b){if(e){var c=e.getCurrentPath();if(c.length){var d=e.getNodeByPath(c.slice(1));d&&(d=d.childController.getCurrentNode(),d&&d.getIndex()===a&&dataAdapter.setNode(c,a,b,function(c){c||uiController.showMessage("Failed to set node","Unable to set node ["+a+"] with value ["+b+"]")}))}}},jumpNode:function(a){dataAdapter.setJumper(e.getCurrentPath(),a)}},this.resetTreeRoot=function(a,b,c){e&&e.remove(),a&&(d=a),d.reset(c+": "+b),e=new E(b)},this.getDescription=function(a){a('<h1>About</h1><hr/><h3><a target="_blank" href="http://zitros.github.io/globalsDB-Admin-NodeJS">GlobalsDB Admin client</a></h3><div>VERSION: '+f+"</div>"),server.send({request:"about"},function(b){b&&b.result&&!b.error&&a(b.result.result)}),server.send({request:"getManifest"},function(b){var c='<h3>GlobalsDB Admin NodeJS Server adapter</h3><div style="display: inline-block; margin: 0 auto; text-align: left;">';b=b.manifest||{};for(var d in b)b.hasOwnProperty(d)&&(c+="<div>"+d+": "+b[d]+"</div>");c+="</div>",a(c)})},this.init=function(){c=A(),z(),a=new B,a.initialize(),e=new E,uiController.init(),uiController.switchConnectForm()}},server=new function(){var a,b,c=!1,d=!1,e=4,f=0,g=4e3,h={},i=[],j=[],k=function(b){return b.__id?(i.push({req:b}),void m()):void a.send(JSON.stringify(b))},l=function(){for(var a=new Date,b=0;b<j.length;b++)a-j[b].timestamp>g-25&&(console.warn("Dead request",j[b].req),h.hasOwnProperty(j[b].req.__id)&&(h[j[b].req.__id]({error:1,reason:"Dead request"}),delete h[j[b].req.__id]),clearTimeout(j[b].timeout),j.splice(b,1),f--)},m=function(){uiController.showLoadingAnimation(0!==i.length);for(var b=f,c=0;e>b&&c<i.length;b++,c++){var d=i.splice(0,1)[0];a.send(JSON.stringify(d.req)),j.push({req:d.req,timeout:setTimeout(l,g),timestamp:new Date}),f++}},n=function(){var a;do a=parseInt(Math.random().toString().substr(2));while(h.hasOwnProperty(a));return a},o=function(a){console.log("Connection error! ",a)},p=function(a){b?b.call(window,a):app.handle.connectionClose(),b=void 0},q=function(a){(a||{}).wasClean||console.log("WS event not clean.",a);for(var b in h)h.hasOwnProperty(b)&&(d&&console.log("<< "+b+" << CONNECTION_ABORT"),h[b](!1,{error:1,result:!1,reason:"Dead server."}),delete h[b]);f=0,p(c=!1)},r=function(){p(c=!0)},s=function(a){try{a=JSON.parse(a.data)}catch(b){return void console.error("Error parsing server data.",a.data)}if(a.__id&&h.hasOwnProperty(a.__id)?(d&&console.log("<< "+a.__id+" <<",a),h[a.__id](a),delete h[a.__id]):d&&console.log("<< [not handled] <<",a),a.__id){f--,m();for(var c=0;c<j.length;c++)j[c].req.__id==a.__id&&(clearTimeout(j[c].timeout),j.splice(c,1))}};this.send=function(a,b){if(!c)return 0;if(b&&"function"==typeof b){var e;h[e=n()]=b,a.__id=e,d&&console.log(">> "+e+" >>",a)}else d&&console.log(">>",a);return k(a),1},this.connect=function(d,e,f){if(c)return void f(!1,{error:1,result:!1,reason:"Already connected."});"function"==typeof f&&(b=f);try{a=new WebSocket("ws://"+d+":"+e)}catch(g){var h={reason:"Wrong url",wasClean:!1};return o(h),void q(h)}a.onopen=r,a.onerror=o,a.onclose=q,a.onmessage=s},this.disconnect=function(){c&&a.close()},this.connected=function(){return c}},uiController=new function(){var a=this,b=null,c=!1,d={infoBar:null,connect:null,login:null,message:null,addNode:null,messageHead:null,messageBody:null,editNode:null,jumpNode:null,about:null},e={connectHostname:null,connectPort:null,connectPassword:null,connectButton:null,loginUsername:null,loginPassword:null,loginNamespace:null,loginDatabase:null,loginButton:null,addNodeName:null,addNodeValue:null,editNodeName:null,editNodeValue:null,jumpNodeName:null,aboutField:null},f=function(){var a=b.childNodes;for(var c in a)a.hasOwnProperty(c)&&"DIV"===a[c].tagName&&(a[c].style.opacity=0,a[c].style.visibility="hidden")},g=function(a){setTimeout(function(){a.focus(),a.select()},50)},h=function(a){f(),a.style.opacity=1,a.style.visibility="visible"},i=function(a){d.infoBar.innerHTML=a?'<img src="img/loading-black.gif"/>':""};this.showLoadingAnimation=i,this.showUI=function(){c=!0,app.switchControl(!1),b.style.left=0},this.hideUI=function(){c=!1,app.switchControl(!0),document.activeElement&&document.activeElement.blur(),b.style.left="100%"},this.switchConnectForm=function(){a.showUI(),h(d.connect),g(e.connectHostname)},this.switchLoginForm=function(){a.showUI(),h(d.login),g(e.loginUsername)},this.switchAddNodeForm=function(){a.showUI(),h(d.addNode),g(e.addNodeName)},this.switchEditNodeForm=function(b,c){e.editNodeName.value=b,e.editNodeValue.value=c,a.showUI(),h(d.editNode),g(e.editNodeValue)},this.switchJumpNodeForm=function(){a.showUI(),h(d.jumpNode)},this.switchInfoPanel=function(){a.showUI(),h(d.about),e.aboutField.innerHTML="",app.getDescription(function(a){e.aboutField.innerHTML+="<p>"+a+"</p>"})};var j={connect:{setWaitingState:function(a){i(a),e.connectButton.disabled=!!a}},login:{setWaitingState:function(a){i(a),e.loginButton.disabled=!!a}}};this.showMessage=function(a,b){d.messageHead.innerHTML=a,d.messageBody.innerHTML=b,d.message.style.left=0},this.handle={connect:function(){if(c){var b={host:e.connectHostname.value,port:e.connectPort.value,masterPassword:e.connectPassword.value};j.connect.setWaitingState(!0),a.hideUI(),server.connect(b.host,b.port,function(c){c?server.send(b,function(b){var c=b.databases||{},d="";for(var f in c)c.hasOwnProperty(f)&&(d+="<option>"+c[f]+"</option>");e.loginDatabase.innerHTML=d,j.connect.setWaitingState(!1),a.switchLoginForm()}):(j.connect.setWaitingState(!1),a.showMessage("Connection error","Unable to connect to "+b.host+":"+b.port),a.switchConnectForm())})}},login:function(){if(c){var b={username:e.loginUsername.value,password:e.loginPassword.value,namespace:e.loginNamespace.value,database:e.loginDatabase.options[e.loginDatabase.selectedIndex].innerHTML};j.connect.setWaitingState(!0),a.hideUI(),server.send(b,function(c){j.connect.setWaitingState(!1),c&&0===c.error?(a.hideUI(),app.resetTreeRoot(null,b.namespace,b.username)):(a.showMessage("Login error","Unable to login. Server reason: "+(c.reason||"[none]")),a.switchLoginForm())})}},messageClose:function(){d.message.style.left="-100%"},addNode:function(){var b=e.addNodeName.value,c=e.addNodeValue.value;return a.hideUI(),b?void app.handle.addNode(b,c):void a.showMessage("Unable to create node",'"name" field is empty.')},editNode:function(){var b=e.editNodeName.value,c=e.editNodeValue.value;return a.hideUI(),b?void app.handle.editNode(b,c):void a.showMessage("Unable to edit node",'"name" field is empty.')},jumpNode:function(){var b=e.jumpNodeName.value;a.hideUI(),app.handle.jumpNode(b)}};var k=function(){e.connectHostname.value=document.location.hostname,e.connectPort.value=57775,e.connectPassword.value="protect"},l=function(a){a&&a.target&&(document.activeElement=a.target==document?null:a.target)};this.init=function(){b=document.getElementById("ui"),d.connect=document.getElementById("ui-connect"),d.login=document.getElementById("ui-login"),d.infoBar=document.getElementById("ui-infoBar"),d.message=document.getElementById("ui-message"),d.messageHead=document.getElementById("ui-message-head"),d.messageBody=document.getElementById("ui-message-body"),d.addNode=document.getElementById("ui-addNode"),d.editNode=document.getElementById("ui-editNode"),d.jumpNode=document.getElementById("ui-jumpNode"),d.about=document.getElementById("ui-about");for(var a in e)e.hasOwnProperty(a)&&void 0===(e[a]=document.getElementById(a))&&console.error("Listed element with ID="+a+" is not present in DOM.");document.addEventListener&&document.addEventListener("focus",l,!0),k()}};